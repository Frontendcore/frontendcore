!function(doc){var Pen,FakePen,utils={};utils.is=function(obj,type){return Object.prototype.toString.call(obj).slice(8,-1)===type},utils.copy=function(defaults,source){for(var p in source)if(source.hasOwnProperty(p)){var val=source[p];defaults[p]=this.is(val,"Object")?this.copy({},val):this.is(val,"Array")?this.copy([],val):val}return defaults},utils.log=function(message,force){(window._pen_debug_mode_on||force)&&console.log("%cPEN DEBUGGER: %c"+message,"font-family:arial,sans-serif;color:#1abf89;line-height:2em;","font-family:cursor,monospace;color:#333;")},utils.shift=function(key,fn,time){time=time||50;var current,queue=this["_shift_fn"+key],timeout="shift_timeout"+key;queue?queue.concat([fn,time]):queue=[[fn,time]],current=queue.pop(),clearTimeout(this[timeout]),this[timeout]=setTimeout(function(){current[0]()},time)},utils.merge=function(config){var defaults={"class":"pen",debug:!1,stay:config.stay||!config.debug,textarea:'<textarea name="content"></textarea>',list:["blockquote","h2","h3","p","insertorderedlist","insertunorderedlist","inserthorizontalrule","indent","outdent","bold","italic","underline","createlink"]};return 1===config.nodeType?defaults.editor=config:config.match&&config.match(/^#[\S]+$/)?defaults.editor=doc.getElementById(config.slice(1)):defaults=utils.copy(defaults,config),defaults},Pen=function(config){if(!config)return utils.log("can't find config",!0);var defaults=utils.merge(config);if(1!==defaults.editor.nodeType)return utils.log("can't find editor");defaults.debug&&(window._pen_debug_mode_on=!0);var editor=defaults.editor;editor.classList.add(defaults["class"]);var editable=editor.getAttribute("contenteditable");editable||editor.setAttribute("contenteditable","true"),this.config=defaults,this._sel=doc.getSelection(),this.actions(),this.toolbar(),this.markdown&&this.markdown.init(this),this.config.stay&&this.stay()},Pen.prototype._effectNode=function(el,returnAsNodeName){for(var nodes=[];el!==this.config.editor;)el.nodeName.match(/(?:[pubia]|h[1-6]|blockquote|[uo]l|li)/i)&&nodes.push(returnAsNodeName?el.nodeName.toLowerCase():el),el=el.parentNode;return nodes},Pen.prototype.nostyle=function(){var els=this.config.editor.querySelectorAll("[style]");return[].slice.call(els).forEach(function(item){item.removeAttribute("style")}),this},Pen.prototype.toolbar=function(){for(var that=this,icons="",i=0,list=this.config.list;i<list.length;i++){var name=list[i],klass="pen-icon icon-"+name;icons+='<i class="'+klass+'" data-action="'+name+'">'+(name.match(/^h[1-6]|p$/i)?name.toUpperCase():"")+"</i>","createlink"===name&&(icons+='<input class="pen-input" placeholder="http://" />')}var menu=doc.createElement("div");menu.setAttribute("class",this.config["class"]+"-menu pen-menu"),menu.innerHTML=icons,menu.style.display="none",doc.body.appendChild(this._menu=menu);var setpos=function(){"block"===menu.style.display&&that.menu()};window.addEventListener("resize",setpos),window.addEventListener("scroll",setpos);var editor=this.config.editor,toggle=function(){that._isDestroyed||utils.shift("toggle_menu",function(){var range=that._sel;range.isCollapsed?that._menu.style.display="none":(that._range=range.getRangeAt(0),that.menu().highlight())},200)};return editor.addEventListener("mouseup",toggle),editor.addEventListener("keyup",toggle),menu.addEventListener("click",function(e){var action=e.target.getAttribute("data-action");if(action){var apply=function(value){that._sel.removeAllRanges(),that._sel.addRange(that._range),that._actions(action,value),that._range=that._sel.getRangeAt(0),that.highlight().nostyle().menu()};if("createlink"===action){var createlink,input=menu.getElementsByTagName("input")[0];return input.style.display="block",input.focus(),createlink=function(input){return input.style.display="none",input.value?apply(input.value.replace(/(^\s+)|(\s+$)/g,"").replace(/^(?!http:\/\/|https:\/\/)(.*)$/,"http://$1")):(action="unlink",void apply())},input.onkeypress=function(e){if(13===e.which)return createlink(e.target)},input.onkeypress}apply()}}),this},Pen.prototype.highlight=function(){var highlight,node=this._sel.focusNode,effects=this._effectNode(node),menu=this._menu,linkInput=menu.querySelector("input");return[].slice.call(menu.querySelectorAll(".active")).forEach(function(el){el.classList.remove("active")}),linkInput&&(linkInput.style.display="none"),highlight=function(str){var selector=".icon-"+str,el=menu.querySelector(selector);return el&&el.classList.add("active")},effects.forEach(function(item){var tag=item.nodeName.toLowerCase();switch(tag){case"a":return menu.querySelector("input").value=item.href,highlight("createlink");case"i":return highlight("italic");case"u":return highlight("underline");case"b":return highlight("bold");case"ul":return highlight("insertunorderedlist");case"ol":return highlight("insertorderedlist");case"ol":return highlight("insertorderedlist");case"li":return highlight("indent");default:highlight(tag)}}),this},Pen.prototype.actions=function(){var reg,block,overall,insert,that=this;return reg={block:/^(?:p|h[1-6]|blockquote|pre)$/,inline:/^(?:bold|italic|underline|insertorderedlist|insertunorderedlist|indent|outdent)$/,source:/^(?:insertimage|createlink|unlink)$/,insert:/^(?:inserthorizontalrule|insert)$/},overall=function(cmd,val){var message=" to exec 「"+cmd+"」 command"+(val?" with value: "+val:"");document.execCommand(cmd,!1,val)&&that.config.debug?utils.log("success"+message):utils.log("fail"+message)},insert=function(name){for(var range=that._sel.getRangeAt(0),node=range.startContainer;1!==node.nodeType;)node=node.parentNode;return range.selectNode(node),range.collapse(!1),overall(name)},block=function(name){if(that._effectNode(that._sel.getRangeAt(0).startContainer,!0).indexOf(name)!==-1){if("blockquote"===name)return document.execCommand("outdent",!1,null);name="p"}return overall("formatblock",name)},this._actions=function(name,value){name.match(reg.block)?block(name):name.match(reg.inline)||name.match(reg.source)?overall(name,value):name.match(reg.insert)?insert(name):this.config.debug&&utils.log("can not find command function for name: "+name+(value?", value: "+value:""))},this},Pen.prototype.menu=function(){var offset=this._range.getBoundingClientRect(),top=offset.top-10,left=offset.left+offset.width/2,menu=this._menu;return menu.style.display="block",menu.style.top=top-menu.clientHeight+"px",menu.style.left=left-menu.clientWidth/2+"px",this},Pen.prototype.stay=function(){var that=this;window.onbeforeunload||(window.onbeforeunload=function(){if(!that._isDestroyed)return"Are you going to leave here?"})},Pen.prototype.destroy=function(isAJoke){var destroy=!isAJoke,attr=isAJoke?"setAttribute":"removeAttribute";return isAJoke||(this._sel.removeAllRanges(),this._menu.style.display="none"),this._isDestroyed=destroy,this.config.editor[attr]("contenteditable",""),this},Pen.prototype.rebuild=function(){return this.destroy("it's a joke")},FakePen=function(config){if(!config)return utils.log("can't find config",!0);var defaults=utils.merge(config),klass=defaults.editor.getAttribute("class");return klass=klass?klass.replace(/\bpen\b/g,"")+" pen-textarea "+defaults["class"]:"pen pen-textarea",defaults.editor.setAttribute("class",klass),defaults.editor.innerHTML=defaults.textarea,defaults.editor},this.Pen=doc.getSelection?Pen:FakePen}(document),function(){if(this.Pen){var covertor={keymap:{96:"`",62:">",49:"1",46:".",45:"-",42:"*",35:"#"},stack:[]};covertor.valid=function(str){var len=str.length;return str.match(/[#]{1,6}/)?["h"+len,len]:"```"===str?["pre",len]:">"===str?["blockquote",len]:"1."===str?["insertorderedlist",len]:"-"===str||"*"===str?["insertunorderedlist",len]:str.match(/(?:\.|\*|\-){3,}/)?["inserthorizontalrule",len]:void 0},covertor.parse=function(e){var code=e.keyCode||e.which;if(32===code){var cmd=this.stack.join("");return this.stack.length=0,this.valid(cmd)}return this.keymap[code]&&this.stack.push(this.keymap[code]),!1},covertor.action=function(pen,cmd){if(!(pen._sel.focusOffset>cmd[1])){var node=pen._sel.focusNode;node.textContent=node.textContent.slice(cmd[1]),pen._actions(cmd[0]),pen.nostyle()}},covertor.init=function(pen){pen.config.editor.addEventListener("keypress",function(e){var cmd=covertor.parse(e);if(cmd)return covertor.action(pen,cmd)})},window.Pen.prototype.markdown=covertor}}(),function(window,document,oGlobalSettings,FrontendTools,FrontendCore,FrontendMediator,$,Pen){"use strict";FrontendCore.define("wysiwyg",[],function(){return{mediator:FrontendMediator,bResize:!1,_oConstants:{EDITOR_SUFIX:"-editor",TEXTAREA_SUFIX:"-textarea",TEXTAREA_CLASS:"fc-wysiwyg-textarea",FULLSCREEN_EDITABLE_CLASS:"fc-wysiwyg-full-screen",TextHelp:"Select some text to get some formatting options.",TextVisual:'<i class="icon-eye"></i> VISUAL',TextHtml:'<i class="icon-code"></i> HTML',TextFullscreen:'<i class="icon-arrows-alt"></i> FULLSCREEN',TextMinscreen:'<i class="icon-minus"></i> MINIMIZE'},oDefault:{"class":"fc-wysiwyg",debug:!1,stay:!1,list:["bold","italic","underline","insertunorderedlist","createlink"]},onStart:function(){var aTargets=FrontendTools.getDataModules("wysiwyg"),self=this;FrontendTools.loadCSS(oGlobalSettings.sPathCss+"secondary.css?v="+oGlobalSettings.sHash),FrontendTools.trackModule("JS_Libraries","call","wysiwyg"),$(aTargets).each(function(){"true"!==this.getAttribute("data-fc-active")&&(this.setAttribute("data-fc-active","true"),self.autobind(this))}),self.fDatePollyfill(),self.mediator.subscribe("close:wysiwyg",this.closeFormatOptions)},fDatePollyfill:function(){Date.now||(Date.now=function(){return(new Date).getTime()})},closeFormatOptions:function(){$(".fc-wysiwyg-menu").hide()},updateTextarea:function(sId,oTarget){oTarget.value="<br>"==document.getElementById(sId).innerHTML?"":document.getElementById(sId).innerHTML},updateEditArea:function(sId,oTarget){document.getElementById(sId).innerHTML=$("#"+oTarget.id).val()},createEditArea:function(sId,oTarget,oText){var oEditArea=document.createElement("div");return oEditArea.id=sId,oEditArea.className="fc-wysiwyg",oEditArea.innerHTML=$(oTarget).text(),oEditArea.setAttribute("data-help",oText.help),oEditArea},createLink:function(sId,sName,sText){var oLink=document.createElement("a");return oLink.innerHTML=sText,oLink.href="#",oLink.id=sName+"-"+sId,oLink.className="button _small",oLink},createLinkGroup:function(aElements){var oLinkGroup=document.createElement("div");oLinkGroup.className="fc-wysiwyg-switch button-group ph-n";for(var nKey=0;nKey<aElements.length;nKey++)oLinkGroup.appendChild(aElements[nKey]);return oLinkGroup},bindForm:function(sId,oTarget){var self=this;$("#"+sId).parents("form").on("submit",function(){$("#"+sId).is(":visible")?self.updateEditArea(sId,oTarget):self.updateTextarea(sId,oTarget)})},bindHtmlButton:function(sId,oTarget,oText){var self=this;$(oTarget).on("focus",function(){$(this).parent().find(".fc-wysiwyg-switch").fadeIn()}).on("blur",function(){$(this).parent().find(".fc-wysiwyg-switch").fadeOut(),self.updateEditArea(sId,oTarget)}),$("#html-"+sId).on("click",function(event){event.preventDefault(),$("#"+sId).toggle(),$("#"+oTarget.id).toggleClass(self._oConstants.TEXTAREA_CLASS),$("#"+sId).is(":visible")?(this.innerHTML=oText.html,self.updateEditArea(sId,oTarget),$("#"+sId).focus()):($(oTarget).focus(),self.bResize===!1&&(require(["autosize"],function(){$(oTarget).autosize()}),self.bResize=!0),self.closeFormatOptions(),this.innerHTML=oText.visual,self.updateTextarea(sId,oTarget))})},bindScreenButton:function(sId,oTarget,oText){var self=this;$("#screen-"+sId).on("click",function(event){event.preventDefault(),$("#"+sId).toggleClass(self._oConstants.FULLSCREEN_EDITABLE_CLASS),$("#"+oTarget.id).toggleClass(self._oConstants.FULLSCREEN_EDITABLE_CLASS),$(this).parent().toggleClass("fc-wysiwyg-switch-full-screen"),$(".pen-menu").toggleClass("pen-menu-full-screen"),this.innerHTML.indexOf(oText.minscreen)==-1?($("body").css({overflow:"hidden",height:"100%"}),this.innerHTML=oText.minscreen):($("body").css({overflow:"auto",height:"auto"}),this.innerHTML=oText.fullscreen)})},bindTextarea:function(sId,oTarget){var self=this;$("#"+sId).on("blur",function(){self.updateTextarea(sId,oTarget),$(this).parent().find(".fc-wysiwyg-switch").fadeOut()}).on("focus",function(){$(this).parent().find(".fc-wysiwyg-switch").fadeIn()})},getText:function(oTarget){for(var sName,self=this,oText={},aText=["visual","help","fullscreen","minscreen","html"],nKey=0;nKey<aText.length;nKey++)sName=aText[nKey],null!==oTarget.getAttribute("data-fc-text-"+sName)?oText[sName]=oTarget.getAttribute("data-fc-text-"+sName):oText[sName]=self._oConstants["Text"+sName.charAt(0).toUpperCase()+sName.slice(1)];return oText},autobind:function(oTarget){$(oTarget).parent().css("position","relative");var oSettings,editor,aValues,oLinkHTML,oLinkScreen,oLinkGroup,oOptions={},self=this,oText=self.getText(oTarget),sDate=Math.floor(Date.now()/1e3),sId=oTarget.id?oTarget.id+self._oConstants.EDITOR_SUFIX:sDate+self._oConstants.EDITOR_SUFIX,sValues=oTarget.getAttribute("data-fc-format-options"),oEditArea=self.createEditArea(sId,oTarget,oText),aLinks=[];if(""===oTarget.id&&(oTarget.id=sDate+self._oConstants.TEXTAREA_SUFIX),window.navigator.userAgent.indexOf("MSIE")===-1&&(null!==oTarget.getAttribute("data-fc-html")?"false"!==oTarget.getAttribute("data-fc-html")&&(oLinkHTML=self.createLink(sId,"html",oText.html),aLinks.push(oLinkHTML)):(oLinkHTML=self.createLink(sId,"html",oText.html),aLinks.push(oLinkHTML)),null!==oTarget.getAttribute("data-fc-fullscreen")?"false"!==oTarget.getAttribute("data-fc-fullscreen")&&(oLinkScreen=self.createLink(sId,"screen",oText.fullscreen),aLinks.push(oLinkScreen)):(oLinkScreen=self.createLink(sId,"screen",oText.fullscreen),aLinks.push(oLinkScreen))),aLinks.length>0&&(oLinkGroup=self.createLinkGroup(aLinks),$(oTarget).after(oLinkGroup)),oTarget.className=self._oConstants.TEXTAREA_CLASS+" fc-wysiwyg-html",$(oTarget).before(oEditArea),oOptions.editor=document.getElementById(sId),oOptions.textarea=oTarget,null!==sValues){aValues=sValues.split(","),oOptions.list=[];for(var nKey=0;aValues.length>nKey;nKey++)oOptions.list.push(aValues[nKey])}oSettings=FrontendTools.mergeOptions(self.oDefault,oOptions),editor=new Pen(oSettings),self.bindForm(sId,oTarget,oText),self.bindTextarea(sId,oTarget,oText),window.navigator.userAgent.indexOf("MSIE")===-1&&(null!==oTarget.getAttribute("data-fc-html")?"false"!==oTarget.getAttribute("data-fc-html")&&self.bindHtmlButton(sId,oTarget,oText):self.bindHtmlButton(sId,oTarget,oText),null!==oTarget.getAttribute("data-fc-fullscreen")?"false"!==oTarget.getAttribute("data-fc-fullscreen")&&self.bindScreenButton(sId,oTarget,oText):self.bindScreenButton(sId,oTarget,oText)),$("div[contenteditable]",oTarget.parentNode).bind("paste",function(e){document.execCommand("insertHTML",!1,e.originalEvent.clipboardData.getData("text")),e.preventDefault()}),FrontendTools.removeLoading(oTarget)}}})}(window,document,oGlobalSettings,FrontendTools,FrontendCore,FrontendMediator,$,Pen);